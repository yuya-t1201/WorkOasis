<div class="container mx-auto py-8">
  <div class="mb-8 flex justify-center">
    <p class="text-black font-semibold"><%= t('workspaces.index.click_to_explore') %></p>
  </div>
  <div class="flex justify-center">
    <div id="map" class="w-full h-screen mb-4"></div>
  </div>
</div>

<style>
  #map {
    height: calc(100vh - 10rem);
  }
</style>

<script>
  let map;
  let infoWindows = [];

  function initMap() {
    const tokyoStation = { lat: 35.681240, lng: 139.766115 };

    map = new google.maps.Map(document.getElementById('map'), {
      center: tokyoStation,
      zoom: 12
    });

    const workspaces = <%= raw @workspaces.to_json %>;

    workspaces.forEach(workspace => {
      const marker = new google.maps.Marker({
        position: { lat: parseFloat(workspace.latitude), lng: parseFloat(workspace.longitude) },
        map: map,
        title: workspace.title
      });

      const infowindow = new google.maps.InfoWindow({
        content: workspace.title
      });

      marker.addListener('click', function () {
        if (infowindow.getMap()) {
          infowindow.close();
          map.setCenter(marker.getPosition());
          map.setZoom(12);
        } else {
          // 選択されたマーカー以外の情報ウィンドウを閉じる
          infoWindows.forEach(window => window.close());

          // 詳細ページへのリンクを作成
          const workspaceLink = `<a href="/workspaces/${workspace.id}">${workspace.title}</a>`;
          infowindow.setContent(workspaceLink);
          infowindow.open(map, marker);
          map.setCenter(marker.getPosition());
          map.setZoom(15); // 詳細ページへのリンクを表示するためにズームイン
        }
      });

      infoWindows.push(infowindow);
    });
  }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap" async defer></script>


